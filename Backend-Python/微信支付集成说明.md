# 微信支付集成说明

## 概述

本文档详细说明了微信支付在AIMedical项目中的完整集成过程，包括后端API开发和Android客户端集成。微信支付采用服务器端统一下单模式，确保支付安全性和可维护性。

## 架构设计

### 服务器端（Backend-Python）

#### 1. 新增文件
- `config/wechat_config.py` - 微信支付配置管理
- `utils/wechat_signature.py` - 微信支付签名工具类
- `utils/wechat_order_builder.py` - 微信支付订单构建器
- `routers/payments.py` - 支付API路由（已扩展微信支付接口）

#### 2. API接口
- `POST /api/v1/payments/wechat/create-order` - 创建微信支付统一下单
- `GET /api/v1/payments/wechat/config` - 获取微信支付配置（非敏感信息）
- `POST /api/v1/payments/wechat/verify-payment` - 验证微信支付结果
- `POST /api/v1/payments/wechat/query-order` - 查询订单状态

### 客户端（Android）

#### 1. 新增文件
- `wxapi/WXPayEntryActivity.java` - 微信支付回调Activity

#### 2. 修改文件
- `app/build.gradle` - 添加微信支付SDK依赖
- `AndroidManifest.xml` - 添加微信支付相关配置
- `api/ApiService.java` - 添加微信支付API接口定义
- `api/ApiClient.java` - 添加支付服务获取方法
- `model/PaymentOrderResponse.java` - 添加微信支付参数支持
- `ProductDetailActivity.java` - 实现微信支付功能

## 配置步骤

### 1. 微信开放平台配置

1. 登录 [微信开放平台](https://open.weixin.qq.com/)
2. 创建移动应用并获取以下信息：
   - `AppID`：应用唯一标识
   - `AppSecret`：应用密钥
3. 申请微信支付功能并获取：
   - `商户号(mch_id)`：微信支付商户号
   - `API密钥(api_key)`：用于签名的密钥

### 2. 服务器端配置

#### 环境变量配置
在 `Backend-Python/.env` 文件中添加：

```env
# 微信支付配置
WECHAT_APP_ID=wx1234567890abcdef
WECHAT_MCH_ID=1234567890
WECHAT_API_KEY=your_api_key_here
WECHAT_NOTIFY_URL=http://your-domain.com/api/v1/payments/wechat/notify
```

#### 配置文件说明

**wechat_config.py**：
- 管理微信支付的基本配置
- 支持环境变量和默认测试值
- 包含API URL、签名类型等配置

**wechat_signature.py**：
- 实现MD5签名算法
- 提供XML与字典转换功能
- 生成随机字符串和时间戳

**wechat_order_builder.py**：
- 构建统一下单请求
- 处理微信支付API响应
- 生成APP支付参数

### 3. Android客户端配置

#### 依赖配置
在 `app/build.gradle` 中添加：

```gradle
dependencies {
    // 微信支付SDK
    implementation 'com.tencent.mm.opensdk:wechat-sdk-android-without-mta:6.8.0'
}
```

#### AndroidManifest.xml配置

```xml
<!-- 微信支付相关权限 -->
<uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" />
<uses-permission android:name="android.permission.RECORD_AUDIO" />

<!-- 查询微信和QQ -->
<queries>
    <package android:name="com.tencent.mm" />
    <package android:name="com.tencent.mobileqq" />
</queries>

<!-- 微信支付回调Activity -->
<activity
    android:name=".wxapi.WXPayEntryActivity"
    android:exported="true"
    android:launchMode="singleTop">
    <intent-filter>
        <action android:name="android.intent.action.VIEW" />
        <category android:name="android.intent.category.DEFAULT" />
        <data android:scheme="wx1234567890abcdef" />
    </intent-filter>
</activity>
```

#### 重要配置说明

1. **包名配置**：
   - `WXPayEntryActivity` 必须放在 `wxapi` 包下
   - 类名必须为 `WXPayEntryActivity`
   - 这是微信支付SDK的强制要求

2. **AppID配置**：
   - 前端和后端的AppID必须保持一致
   - 当前使用测试AppID：`wx1234567890abcdef`
   - 实际使用时需要替换为真实的微信AppID

## 工作流程

### 1. 支付流程

1. **用户发起支付**：
   - 用户在商品详情页点击微信支付
   - 客户端显示加载对话框

2. **服务器统一下单**：
   - 客户端调用 `/api/v1/payments/wechat/create-order` API
   - 服务器验证商品信息和库存
   - 生成订单号并调用微信统一下单API
   - 返回APP支付参数

3. **客户端发起支付**：
   - 接收服务器返回的支付参数
   - 检查微信客户端安装和版本
   - 调用微信SDK发起支付

4. **支付结果处理**：
   - 微信客户端返回支付结果
   - `WXPayEntryActivity` 处理回调
   - 显示支付结果并更新UI

### 2. 关键代码说明

#### 服务器端统一下单

```python
# 创建微信支付订单
@router.post("/wechat/create-order")
async def create_wechat_order(request: PaymentOrderRequest, db: Session = Depends(get_db)):
    # 1. 验证商品信息
    # 2. 构建订单参数
    # 3. 调用微信统一下单API
    # 4. 生成APP支付参数
    # 5. 返回支付参数
```

#### Android客户端支付调用

```java
// 发起微信支付
private void startWechatPay(PaymentOrderResponse.OrderInfo orderInfo) {
    // 1. 检查微信客户端
    // 2. 构建支付请求
    // 3. 调用微信SDK
    PayReq payReq = new PayReq();
    // 设置支付参数...
    wxApi.sendReq(payReq);
}
```

## 测试指南

### 1. 开发环境测试

1. **启动后端服务**：
   ```bash
   cd Backend-Python
   python -m uvicorn main:app --reload --host 0.0.0.0 --port 8000
   ```

2. **测试API接口**：
   ```bash
   curl -X POST "http://localhost:8000/api/v1/payments/wechat/create-order" \
        -H "Content-Type: application/json" \
        -d '{"product_id":1,"quantity":1}'
   ```

3. **Android应用测试**：
   - 确保设备已安装微信客户端
   - 在商品详情页选择微信支付
   - 观察支付流程和结果处理

### 2. 常见问题排查

1. **签名错误**：
   - 检查API密钥配置
   - 验证参数排序和编码
   - 确认签名算法实现

2. **AppID不匹配**：
   - 检查前后端AppID一致性
   - 验证微信开放平台配置
   - 确认包名和签名配置

3. **网络请求失败**：
   - 检查服务器网络配置
   - 验证防火墙设置
   - 确认API接口可访问性

4. **微信客户端问题**：
   - 确认微信客户端已安装
   - 检查微信版本支持
   - 验证Intent-filter配置

## 安全注意事项

1. **密钥管理**：
   - API密钥存储在服务器端
   - 使用环境变量管理敏感信息
   - 定期更换API密钥

2. **签名验证**：
   - 所有请求都进行签名验证
   - 验证回调通知的签名
   - 防止参数篡改

3. **订单安全**：
   - 服务器端验证订单金额
   - 防止重复支付
   - 记录支付日志

## 部署注意事项

1. **生产环境配置**：
   - 替换为真实的微信AppID和商户号
   - 配置正确的回调URL
   - 设置HTTPS证书

2. **服务器配置**：
   - 配置反向代理（Nginx）
   - 设置防火墙规则
   - 配置日志记录

3. **监控和维护**：
   - 监控支付成功率
   - 记录异常日志
   - 定期检查配置

## 优势总结

1. **安全性**：服务器端统一下单，密钥不暴露给客户端
2. **可维护性**：支付逻辑集中管理，便于更新和维护
3. **一致性**：所有客户端使用相同的支付逻辑
4. **可扩展性**：易于添加其他支付方式
5. **监控性**：服务器端可以记录和监控所有支付请求

## 版本信息

- 微信支付SDK版本：6.8.0
- 支持的微信客户端版本：6.0+
- Android最低版本：API 21 (Android 5.0)
- 后端框架：FastAPI
- 数据库：SQLite/PostgreSQL

配置完成后，微信支付功能将完全通过服务器端处理，提供安全可靠的支付体验。