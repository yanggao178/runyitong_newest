# 支付宝服务器端配置说明

## 概述

已成功将支付宝支付的订单信息生成和签名逻辑迁移到服务器端，客户端现在只负责调用支付。这种架构提供了更好的安全性和可维护性。

## 架构变更

### 服务器端（Backend-Python）

#### 1. 新增文件
- `config/alipay_config.py` - 支付宝配置管理
- `utils/alipay_signature.py` - RSA2签名工具类
- `utils/alipay_order_builder.py` - 订单信息构建器
- `routers/payments.py` - 支付API路由

#### 2. API接口
- `POST /api/v1/payments/alipay/create-order` - 创建支付宝订单
- `GET /api/v1/payments/alipay/config` - 获取支付宝配置（非敏感信息）
- `POST /api/v1/payments/alipay/verify-payment` - 验证支付结果

### 客户端（Android）

#### 1. 新增文件
- `model/PaymentOrderRequest.java` - 支付订单请求模型
- `model/PaymentOrderResponse.java` - 支付订单响应模型

#### 2. 修改文件
- `api/ApiService.java` - 添加支付API接口定义
- `api/ApiClient.java` - 增强网络请求处理（重试机制、错误处理）
- `ProductDetailActivity.java` - 修改支付逻辑为调用服务器API

## 配置步骤

### 1. 支付宝开发者账号配置

1. 登录 [支付宝开放平台](https://open.alipay.com/)
2. 创建应用并获取以下信息：
   - `APPID`：应用唯一标识
   - `应用私钥`：用于签名的RSA2私钥
   - `支付宝公钥`：用于验证支付宝返回数据的公钥

### 2. 服务器端配置

#### 方式一：环境变量配置（推荐）

在服务器环境中设置以下环境变量：

```bash
# 支付宝配置
export ALIPAY_APP_ID="你的真实APPID"
export ALIPAY_PRIVATE_KEY="你的应用私钥"
export ALIPAY_PUBLIC_KEY="支付宝公钥"
export ALIPAY_GATEWAY_URL="https://openapi.alipay.com/gateway.do"  # 正式环境
# export ALIPAY_GATEWAY_URL="https://openapi.alipaydev.com/gateway.do"  # 沙箱环境
```

#### 方式二：直接修改配置文件

修改 `config/alipay_config.py` 文件：

```python
class AlipayConfig:
    # 替换为你的真实配置
    APP_ID = "你的真实APPID"
    PRIVATE_KEY = """-----BEGIN RSA PRIVATE KEY-----
你的应用私钥内容
-----END RSA PRIVATE KEY-----"""
    
    ALIPAY_PUBLIC_KEY = """-----BEGIN PUBLIC KEY-----
支付宝公钥内容
-----END PUBLIC KEY-----"""
```

### 3. 安全注意事项

1. **私钥安全**：
   - 私钥绝不应该提交到版本控制系统
   - 生产环境建议使用环境变量或密钥管理服务
   - 定期轮换密钥

2. **网络安全**：
   - 使用HTTPS协议
   - 实施API访问限制和频率控制
   - 添加请求签名验证

3. **日志安全**：
   - 不要在日志中记录敏感信息
   - 对订单信息进行脱敏处理

### 4. 测试配置

#### 沙箱环境测试

1. 使用支付宝沙箱环境进行测试
2. 配置沙箱APPID和密钥
3. 设置网关地址为沙箱环境

#### 本地测试

```bash
# 启动后端服务
cd Backend-Python
python -m uvicorn main:app --reload --host 0.0.0.0 --port 8000

# 测试API接口
curl -X POST "http://localhost:8000/api/v1/payments/alipay/create-order" \
     -H "Content-Type: application/x-www-form-urlencoded" \
     -d "product_id=1&quantity=1&timeout_express=30m"
```

### 5. 部署注意事项

1. **依赖安装**：
   ```bash
   pip install cryptography
   ```

2. **数据库配置**：
   - 确保Product表存在且有正确的数据
   - 检查数据库连接配置

3. **服务器配置**：
   - 配置反向代理（Nginx）
   - 设置SSL证书
   - 配置防火墙规则

## 工作流程

1. **客户端发起支付**：
   - 用户点击支付按钮
   - 客户端调用 `/api/v1/payments/alipay/create-order` API

2. **服务器处理订单**：
   - 验证商品信息
   - 生成订单号
   - 构建订单参数
   - 使用RSA2算法签名
   - 返回已签名的订单字符串

3. **客户端执行支付**：
   - 接收服务器返回的订单字符串
   - 调用支付宝SDK执行支付
   - 处理支付结果

4. **支付结果验证**：
   - 客户端接收支付结果
   - 可选：调用服务器验证支付结果

## 优势

1. **安全性**：私钥和签名逻辑在服务器端，避免客户端泄露
2. **可维护性**：支付逻辑集中管理，便于更新和维护
3. **一致性**：所有客户端使用相同的支付逻辑
4. **可扩展性**：易于添加其他支付方式
5. **监控性**：服务器端可以记录和监控所有支付请求

## 故障排除

1. **签名错误**：检查私钥格式和内容
2. **网络超时**：检查服务器网络配置和防火墙
3. **参数错误**：检查API请求参数格式
4. **数据库错误**：检查数据库连接和表结构

配置完成后，支付宝支付功能将完全通过服务器端处理，提供更安全可靠的支付体验。