# 医学影像深度学习模型集成指南

## 概述

当前系统使用传统图像处理方法进行医学影像类型检测，这是一个临时解决方案。在实际生产环境中，应该使用深度学习模型来提高准确率和可靠性。

## 当前实现 vs 深度学习模型

### 当前实现（传统方法）
- **准确率**: 约60-80%
- **方法**: 基于手工设计的图像特征（亮度、对比度、边缘密度等）
- **优点**: 无需额外依赖，部署简单
- **缺点**: 准确率有限，难以处理复杂情况

### 深度学习模型（推荐）
- **准确率**: 通常>95%
- **方法**: 端到端学习，自动特征提取
- **优点**: 高准确率，强泛化能力，支持更多影像类型
- **缺点**: 需要GPU资源，模型文件较大

## 集成步骤

### 1. 环境准备

#### 安装深度学习框架
```bash
# 选择一个框架安装

# TensorFlow (推荐)
pip install tensorflow>=2.10.0
pip install tensorflow-gpu  # 如果有GPU

# 或者 PyTorch
pip install torch torchvision torchaudio
```

#### 安装图像处理依赖
```bash
pip install Pillow>=9.0.0
pip install scikit-image>=0.19.0
```

### 2. 模型准备

#### 选项A: 使用预训练模型
```python
# 下载预训练的医学影像分类模型
# 推荐的模型架构：
# - ResNet50/101 (适合X光、CT)
# - EfficientNet (平衡准确率和速度)
# - DenseNet (适合细粒度分类)
# - Vision Transformer (最新技术，需要更多计算资源)
```

#### 选项B: 训练自定义模型
```python
# 数据集要求：
# - X光片: 至少10,000张标注图像
# - CT扫描: 至少5,000张标注图像
# - MRI: 至少5,000张标注图像
# - 超声: 至少3,000张标注图像
# - PET-CT: 至少2,000张标注图像

# 推荐的数据增强策略：
# - 旋转 (-15° to +15°)
# - 缩放 (0.8x to 1.2x)
# - 亮度调整 (±20%)
# - 对比度调整 (±20%)
# - 高斯噪声
```

### 3. 代码集成

#### 修改 `prescriptions.py`
```python
# 在文件顶部添加导入
from ai.medical_image_classifier import classify_medical_image

# 修改 detect_medical_image_type 函数
def detect_medical_image_type(image_array):
    """
    使用深度学习模型检测医学影像类型
    """
    try:
        # 使用深度学习分类器
        predicted_type = classify_medical_image(image_array)
        print(f"深度学习模型预测结果: {predicted_type}")
        return predicted_type
        
    except Exception as e:
        print(f"深度学习模型推理失败，使用备用方法: {str(e)}")
        # 备用：使用传统方法
        return fallback_traditional_method(image_array)
```

#### 更新 `medical_image_classifier.py`
```python
# 加载真实的预训练模型
def load_model(self, model_path: str):
    if model_path.endswith('.h5') or model_path.endswith('.keras'):
        # TensorFlow/Keras模型
        import tensorflow as tf
        self.model = tf.keras.models.load_model(model_path)
        self.framework = 'tensorflow'
    elif model_path.endswith('.pth') or model_path.endswith('.pt'):
        # PyTorch模型
        import torch
        self.model = torch.load(model_path, map_location='cpu')
        self.model.eval()
        self.framework = 'pytorch'
    
    self.is_loaded = True
    return True
```

### 4. 模型部署配置

#### 创建模型配置文件 `model_config.json`
```json
{
    "model_path": "models/medical_image_classifier.h5",
    "framework": "tensorflow",
    "input_size": [224, 224, 3],
    "class_names": ["xray", "ct", "mri", "ultrasound", "petct"],
    "confidence_threshold": 0.8,
    "preprocessing": {
        "normalize": true,
        "mean": [0.485, 0.456, 0.406],
        "std": [0.229, 0.224, 0.225]
    }
}
```

#### 环境变量配置
```bash
# 在 .env 文件中添加
USE_DEEP_LEARNING=true
MODEL_PATH=models/medical_image_classifier.h5
GPU_ENABLED=true
BATCH_SIZE=1
```

### 5. 性能优化

#### GPU加速
```python
# 检查GPU可用性
import tensorflow as tf
print("GPU可用:", tf.config.list_physical_devices('GPU'))

# 或者PyTorch
import torch
print("GPU可用:", torch.cuda.is_available())
```

#### 模型量化（减少内存使用）
```python
# TensorFlow Lite量化
converter = tf.lite.TFLiteConverter.from_keras_model(model)
converter.optimizations = [tf.lite.Optimize.DEFAULT]
tflite_model = converter.convert()

# PyTorch量化
import torch.quantization as quantization
quantized_model = quantization.quantize_dynamic(
    model, {torch.nn.Linear}, dtype=torch.qint8
)
```

### 6. 监控和日志

#### 添加性能监控
```python
import time
import logging

def classify_with_monitoring(image_array):
    start_time = time.time()
    
    try:
        result = classify_medical_image(image_array)
        inference_time = time.time() - start_time
        
        logging.info(f"推理成功: {result}, 耗时: {inference_time:.3f}s")
        return result
        
    except Exception as e:
        logging.error(f"推理失败: {str(e)}")
        raise
```

### 7. 测试和验证

#### 创建测试脚本
```python
# test_deep_learning_model.py
import numpy as np
from ai.medical_image_classifier import get_classifier

def test_model_accuracy():
    classifier = get_classifier()
    
    # 加载测试数据集
    test_images, test_labels = load_test_dataset()
    
    correct = 0
    total = len(test_images)
    
    for image, true_label in zip(test_images, test_labels):
        predicted_label, confidence = classifier.classify(image)
        if predicted_label == true_label:
            correct += 1
    
    accuracy = correct / total
    print(f"模型准确率: {accuracy:.3f}")
    return accuracy

if __name__ == "__main__":
    test_model_accuracy()
```

## 部署检查清单

- [ ] 安装深度学习框架
- [ ] 准备预训练模型文件
- [ ] 更新代码以使用深度学习分类器
- [ ] 配置GPU支持（如果可用）
- [ ] 设置环境变量
- [ ] 测试模型准确率
- [ ] 配置监控和日志
- [ ] 性能基准测试
- [ ] 备用方案测试

## 常见问题

### Q: 模型文件太大怎么办？
A: 可以使用模型量化、剪枝或知识蒸馏技术减小模型大小。

### Q: 推理速度太慢怎么办？
A: 考虑使用GPU加速、模型优化或选择更轻量的模型架构。

### Q: 如何处理新的影像类型？
A: 收集新类型的标注数据，重新训练或微调模型。

### Q: 模型准确率不够怎么办？
A: 增加训练数据、改进数据质量、尝试更先进的模型架构或集成多个模型。

## 推荐资源

- **数据集**: 
  - NIH Chest X-ray Dataset
  - MIMIC-CXR Database
  - RadiAnt DICOM Viewer

- **预训练模型**:
  - TensorFlow Hub医学影像模型
  - PyTorch Hub医学影像模型
  - Hugging Face医学影像模型

- **论文参考**:
  - "Deep Learning for Medical Image Analysis" (2017)
  - "Attention U-Net: Learning Where to Look for the Pancreas" (2018)
  - "Vision Transformer for Medical Image Classification" (2021)

## 联系支持

如需技术支持或有疑问，请联系开发团队。