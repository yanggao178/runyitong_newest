# 快递查询功能使用指南

## query_kuaidi_niao函数说明

`query_kuaidi_niao`函数用于调用快递鸟API查询物流信息，现在已支持传入寄件人手机号。

### 函数签名
```python
def query_kuaidi_niao(order_sn: str, shipper_code: str, sender_phone: Optional[str] = None) -> Dict:
    """
    调用快递鸟API查询物流信息
    :param order_sn: 快递单号
    :param shipper_code: 快递公司代码
    :param sender_phone: 寄件人手机号（可选，用于获取后4位作为CustomerName）
    :return: 查询结果
    """
```

## 调用示例

### 1. 基本调用（不传入手机号）

```python
from routers.express import query_kuaidi_niao

# 基本调用，不传入手机号
result = query_kuaidi_niao(
    order_sn="SF1234567890123",  # 快递单号
    shipper_code="SF"            # 快递公司代码（顺丰速运）
)

print(result)
# 输出示例:
# {
#     "success": True,
#     "data": {
#         "shipper_code": "SF",
#         "order_sn": "SF1234567890123",
#         "status": "success",
#         "traces": [
#             {"time": "2023-10-01 10:30:00", "description": "已签收"},
#             {"time": "2023-10-01 09:00:00", "description": "派送中"}
#         ]
#     },
#     "message": "查询成功"
# }
```

### 2. 传入寄件人手机号调用

```python
from routers.express import query_kuaidi_niao

# 传入寄件人手机号调用
result = query_kuaidi_niao(
    order_sn="SF1234567890123",  # 快递单号
    shipper_code="SF",           # 快递公司代码（顺丰速运）
    sender_phone="13800138000"   # 寄件人手机号
)

print(result)
```

### 3. API接口调用示例

通过REST API接口调用快递查询功能：

```bash
# 使用curl调用API接口
dcurl "http://localhost:8000/v1/express/track?order_sn=SF1234567890123&shipper_code=SF&sender_phone=13800138000"
```

在前端JavaScript中调用：

```javascript
// 前端AJAX调用示例
fetch('http://localhost:8000/v1/express/track?order_sn=SF1234567890123&shipper_code=SF&sender_phone=13800138000')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('物流信息:', data.data.traces);
        } else {
            console.error('查询失败:', data.message);
        }
    })
    .catch(error => console.error('请求错误:', error));
```

## 注意事项

1. **手机号格式**：
   - 如果提供了有效的数字格式手机号且长度≥4位，系统会自动提取后4位作为CustomerName
   - 如果手机号格式不正确或未提供，系统将使用默认值"1234"

2. **快递公司代码**：
   - 支持的快递公司代码请参考`express_companies`字典
   - 常见代码：SF（顺丰）、YTO（圆通）、ZTO（中通）、YD（韵达）等

3. **API错误处理**：
   - 函数会捕获所有异常并返回统一格式的错误信息
   - 检查返回结果中的`success`字段判断操作是否成功

4. **日志记录**：
   - 所有API调用都会记录详细日志，包括请求参数、签名生成过程和响应内容
   - 日志保存在项目的logs目录下

## 测试账号说明

当前系统使用的是快递鸟测试账号，可能会遇到"业务错误[没有可用套餐]"的提示。在生产环境中，请确保配置有效的快递鸟API账号信息。

配置信息位于`.env`文件中：
- KUAI_DINIAO_APP_ID：快递鸟用户ID
- KUAI_DINIAO_API_KEY：快递鸟API Key
- KUAI_DINIAO_REQUEST_URL：API请求URL